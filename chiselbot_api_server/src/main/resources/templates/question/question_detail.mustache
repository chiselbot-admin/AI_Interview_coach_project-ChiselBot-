{{> layout/header }}
<body id="page-top">
<div id="wrapper">
    {{> layout/sidebar }}
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            {{> layout/topbar }}
            <!-- 레이아웃 작업 부분 -->
            <div class="container mt-5">
                <h2 class="mb-4 text-center fw-bold">질문 상세 / 수정</h2>
                <div class="form-container">
                    <form action="/admin/questions/update" method="post">
                        <input type="hidden" name="questionId" value="{{question.questionId}}">

                        <!-- 카테고리 선택 -->
                        <div class="mb-3">
                            <label class="form-label">카테고리(Category)</label>
                            <select class="form-select" name="categoryId" id="categorySelect" required>
                                <option value="" selected disabled hidden>카테고리를 선택하세요</option>
                                {{#categories}}
                                    <option value="{{categoryId}}">{{name}}</option>
                                {{/categories}}
                            </select>
                        </div>

                        <!-- 레벨 선택 -->
                        <div class="mb-3">
                            <label class="form-label">레벨(Level)</label>
                            <select class="form-select" name="interviewLevel" id="interviewLevel" required>
                                <option value="LEVEL_1" {{#question.isLevel1}}selected{{/question.isLevel1}}>LEVEL_1</option>
                                <option value="LEVEL_2" {{#question.isLevel2}}selected{{/question.isLevel2}}>LEVEL_2</option>
                                <option value="LEVEL_3" {{#question.isLevel3}}selected{{/question.isLevel3}}>LEVEL_3</option>
                            </select>
                        </div>

                        <!-- 질문 내용 -->
                        <div class="mb-3">
                            <label class="form-label">질문 내용</label>
                            <textarea class="form-control" name="questionText" rows="3" required>{{question.questionText}}</textarea>
                        </div>

                        <!-- 의도 -->
                        <div class="mb-3" id="intentGroup">
                            <label class="form-label">의도(Intent)</label>
                            <textarea class="form-control" name="intentText" rows="2">{{question.intentText}}</textarea>
                        </div>

                        <!-- 포인트 -->
                        <div class="mb-3" id="pointGroup">
                            <label class="form-label">핵심 포인트(Point)</label>
                            <textarea class="form-control" name="pointText" rows="2">{{question.pointText}}</textarea>
                        </div>

                        <!-- 답변 -->
                        {{#question.answerText}}
                            <div class="mb-3" id="answerGroup">
                                <label class="form-label">모범 답변</label>
                                <textarea class="form-control" name="answerText" rows="3">{{question.answerText}}</textarea>
                            </div>
                        {{/question.answerText}}

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div class="flex-grow-1 text-center">
                                <button type="submit" class="btn btn-primary px-4">수정</button>
                                <a href="/admin/questions" class="btn btn-secondary ms-2">목록으로</a>
                            </div>
                        </div>
                    </form>

                    <div class="text-end mt-3">
                        <form action="/admin/questions/{{question.questionId}}/delete" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger"
                                    onclick="return confirm('정말 이 질문을 삭제하시겠습니까?');">
                                삭제하기
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        {{> layout/footer }}
    </div>
</div>

<style>
    body { background-color: #f8f9fa; }
    .form-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 30px;
      margin-top: 40px;
    }
    .form-label { font-weight: 600; }
    .hidden { display: none !important; }
    textarea.form-control { resize: none; }
</style>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      const levelSelect = document.getElementById("interviewLevel");
      const intentGroup = document.getElementById("intentGroup");
      const pointGroup = document.getElementById("pointGroup");
      const answerGroup = document.getElementById("answerGroup");

      const intentInput = intentGroup.querySelector("textarea");
      const pointInput = pointGroup.querySelector("textarea");
      const answerInput = answerGroup.querySelector("textarea");

      let prevLevel = levelSelect.value;

      function applyLevelUI(value) {
        if (value === "LEVEL_1") {
          intentGroup.classList.add("hidden");
          pointGroup.classList.add("hidden");
          answerGroup.classList.remove("hidden");
        } else {
          intentGroup.classList.remove("hidden");
          pointGroup.classList.remove("hidden");
          answerGroup.classList.add("hidden");
        }
      }

      // 초기 UI 적용
      applyLevelUI(levelSelect.value);

      // 레벨 변경 시 경고 처리
      levelSelect.addEventListener("change", function () {
        const hasValues =
          intentInput.value.trim() !== "" ||
          pointInput.value.trim() !== "" ||
          answerInput.value.trim() !== "";

        if (hasValues) {
          const confirmChange = confirm("입력한 내용이 사라질 수 있습니다. 변경하시겠습니까?");
          if (!confirmChange) {
            levelSelect.value = prevLevel; // 복원
            return;
          } else {
            // 동의 시 실제 반영 + 값 초기화
            intentInput.value = "";
            pointInput.value = "";
            answerInput.value = "";
            applyLevelUI(levelSelect.value);
            prevLevel = levelSelect.value;
          }
        } else {
          applyLevelUI(levelSelect.value);
          prevLevel = levelSelect.value;
        }
      });
    });

    // 카테고리 로드
    const categorySelect = document.getElementById("categorySelect");
    const currentCategoryId = "{{question.categoryId}}"; // 서버에서 내려준 현재 카테고리 ID

    Array.from(categorySelect.options).forEach(option => {
      if (option.value === currentCategoryId) {
        option.selected = true;
      }
    });
</script>

</body>
</html>
